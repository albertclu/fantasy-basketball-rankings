<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GQ Standings Admin</title>
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:       #0d0f14;
      --surface:  #151820;
      --border:   #252a35;
      --accent:   #f5a623;
      --accent2:  #4a9eff;
      --success:  #3ddc84;
      --error:    #ff4d4d;
      --text:     #e8eaf0;
      --muted:    #6b7280;
    }

    body {
      font-family: 'DM Mono', monospace;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 40px 20px;
    }

    .wrap { max-width: 700px; margin: 0 auto; }

    header {
      margin-bottom: 40px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 24px;
    }

    h1 {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 3rem;
      letter-spacing: 0.05em;
      color: var(--accent);
      line-height: 1;
    }

    h1 span { color: var(--text); }

    .subtitle {
      color: var(--muted);
      font-size: 0.75rem;
      margin-top: 6px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 24px;
      margin-bottom: 20px;
    }

    .card-title {
      font-size: 0.65rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--muted);
      margin-bottom: 16px;
    }

    label {
      display: block;
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--muted);
      margin-bottom: 6px;
      margin-top: 14px;
    }

    label:first-of-type { margin-top: 0; }

    input {
      width: 100%;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 5px;
      color: var(--text);
      font-family: 'DM Mono', monospace;
      font-size: 0.78rem;
      padding: 10px 12px;
      outline: none;
      transition: border-color 0.2s;
    }

    input:focus { border-color: var(--accent2); }

    .hint {
      font-size: 0.65rem;
      color: var(--muted);
      margin-top: 5px;
      line-height: 1.5;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-family: 'DM Mono', monospace;
      font-size: 0.78rem;
      font-weight: 500;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      padding: 12px 24px;
      border-radius: 5px;
      border: none;
      cursor: pointer;
      transition: opacity 0.2s, transform 0.1s;
      margin-top: 4px;
    }

    .btn:hover:not(:disabled) { opacity: 0.85; }
    .btn:active:not(:disabled) { transform: scale(0.98); }
    .btn:disabled { opacity: 0.4; cursor: not-allowed; }

    .btn-primary { background: var(--accent); color: #000; }
    .btn-secondary { background: var(--accent2); color: #000; }
    .btn-success { background: var(--success); color: #000; }

    .btn-row { display: flex; gap: 12px; flex-wrap: wrap; margin-top: 20px; }

    /* Log output */
    #log {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 5px;
      padding: 16px;
      font-size: 0.72rem;
      line-height: 1.8;
      min-height: 80px;
      max-height: 300px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-break: break-all;
    }

    .log-ok   { color: var(--success); }
    .log-err  { color: var(--error); }
    .log-info { color: var(--accent2); }
    .log-warn { color: var(--accent); }

    /* Preview table */
    #preview { display: none; margin-top: 20px; }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.7rem;
    }

    th {
      text-align: left;
      padding: 8px 10px;
      border-bottom: 1px solid var(--border);
      color: var(--muted);
      font-size: 0.62rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    td {
      padding: 8px 10px;
      border-bottom: 1px solid var(--border);
    }

    tbody tr:hover { background: rgba(255,255,255,0.02); }

    .rank-badge {
      display: inline-block;
      width: 22px;
      height: 22px;
      line-height: 22px;
      text-align: center;
      border-radius: 50%;
      background: var(--border);
      font-size: 0.65rem;
      font-weight: 500;
    }

    .rank-1 { background: var(--accent); color: #000; }
    .rank-2 { background: #a0a0a0; color: #000; }
    .rank-3 { background: #cd7f32; color: #000; }

    .score-val { color: var(--accent); font-weight: 500; }

    .status-dot {
      display: inline-block;
      width: 8px; height: 8px;
      border-radius: 50%;
      margin-right: 6px;
    }
    .dot-idle    { background: var(--muted); }
    .dot-working { background: var(--accent); animation: pulse 1s infinite; }
    .dot-ok      { background: var(--success); }
    .dot-err     { background: var(--error); }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50%       { opacity: 0.3; }
    }

    #statusBar {
      display: flex;
      align-items: center;
      font-size: 0.7rem;
      color: var(--muted);
      margin-bottom: 16px;
    }
  </style>
</head>
<body>
<div class="wrap">

  <header>
    <h1>GQ <span>Admin</span></h1>
    <p class="subtitle">Fantasy Basketball · Standings Updater</p>
  </header>

  <!-- Step 1: GitHub token -->
  <div class="card">
    <div class="card-title">Step 1 — GitHub Personal Access Token</div>

    <label>Token</label>
    <input type="password" id="ghToken" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx" />
    <p class="hint">
      Generate at github.com → Settings → Developer settings → Personal access tokens → Fine-grained tokens<br>
      Needs <strong>Contents: Read & Write</strong> permission on your repo.
      Token is only stored in memory — never sent anywhere except GitHub's API.
    </p>

    <label>GitHub Repo (owner/repo)</label>
    <input type="text" id="ghRepo" placeholder="your-username/your-repo-name" />

    <label>Branch</label>
    <input type="text" id="ghBranch" value="main" />
  </div>

  <!-- Step 2: Fetch ESPN -->
  <div class="card">
    <div class="card-title">Step 2 — Fetch ESPN Data</div>
    <p class="hint" style="margin-bottom:16px;">
      This runs directly from your browser while you're logged into ESPN.<br>
      Make sure you're logged into <strong>fantasy.espn.com</strong> in this browser before clicking.
    </p>

    <div id="statusBar">
      <span class="status-dot dot-idle" id="dot"></span>
      <span id="statusText">Ready</span>
    </div>

    <div id="log">Waiting...</div>

    <div id="preview">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Team</th>
            <th>Score</th>
            <th>PTS</th>
            <th>REB</th>
            <th>AST</th>
            <th>GP</th>
          </tr>
        </thead>
        <tbody id="previewBody"></tbody>
      </table>
    </div>

    <div class="btn-row">
      <button class="btn btn-primary" onclick="fetchESPN()">⬇ Fetch ESPN Data</button>
      <button class="btn btn-success" id="pushBtn" onclick="pushToGitHub()" disabled>⬆ Push to GitHub</button>
    </div>
  </div>

</div>

<script>
// ─── CONFIG ───────────────────────────────────────────────────────────────────
const LEAGUE_ID = '24352';
const SEASON_ID = '2026';
const FILE_PATH = 'data/teams.json'; // path in your repo

const STAT = {
  pts: 0, blk: 1, stl: 2, ast: 3, reb: 6,
  threePM: 17, fgm: 19, fga: 20, ftm: 40, fta: 41, gp: 38
};
// ─────────────────────────────────────────────────────────────────────────────

let parsedTeams = null;

function log(msg, type = 'info') {
  const el = document.getElementById('log');
  const line = document.createElement('div');
  line.className = `log-${type}`;
  const ts = new Date().toLocaleTimeString();
  line.textContent = `[${ts}] ${msg}`;
  el.appendChild(line);
  el.scrollTop = el.scrollHeight;
}

function setStatus(state, text) {
  const dot = document.getElementById('dot');
  dot.className = `status-dot dot-${state}`;
  document.getElementById('statusText').textContent = text;
}

function safeGet(obj, id) {
  const v = obj?.[String(id)];
  return (v !== undefined && v !== null && !isNaN(v)) ? Number(v) : 0;
}

function rankTeams(teams) {
  const cats = ['fgPct','ftPct','threePM','reb','ast','stl','blk','pts'];
  const keys  = {
    fgPct: 'fgPct', ftPct: 'ftPct',
    threePM: 'threePMAvg', reb: 'rebAvg', ast: 'astAvg',
    stl: 'stlAvg', blk: 'blkAvg', pts: 'ptsAvg'
  };

  // Compute per-game averages
  teams.forEach(t => {
    const g = t.gp || 550;
    t.threePMAvg = t.threePM / g;
    t.rebAvg = t.reb / g;
    t.astAvg = t.ast / g;
    t.stlAvg = t.stl / g;
    t.blkAvg = t.blk / g;
    t.ptsAvg = t.pts / g;
    t.categoryRanks = {};
  });

  cats.forEach(cat => {
    const key = keys[cat];
    const sorted = [...teams].sort((a,b) => b[key] - a[key]);
    teams.forEach(t => {
      t.categoryRanks[cat] = 11 - (sorted.indexOf(t) + 1);
    });
  });

  teams.forEach(t => {
    t.totalScore = Object.values(t.categoryRanks).reduce((a,b) => a+b, 0);
  });

  return teams.sort((a,b) => b.totalScore - a.totalScore);
}

async function fetchESPN() {
  document.getElementById('log').innerHTML = '';
  document.getElementById('preview').style.display = 'none';
  document.getElementById('pushBtn').disabled = true;
  parsedTeams = null;

  setStatus('working', 'Fetching ESPN...');
  log('Connecting to ESPN Fantasy API...', 'info');

  const url = `https://fantasy.espn.com/apis/v3/games/fba/seasons/${SEASON_ID}/segments/0/leagues/${LEAGUE_ID}?view=mTeam&view=mRoster`;

  try {
    const res = await fetch(url, {
      credentials: 'include', // uses your browser's ESPN session cookies automatically
      headers: {
        'Accept': 'application/json',
        'x-fantasy-source': 'kona',
      }
    });

    log(`Response status: ${res.status}`, res.ok ? 'ok' : 'err');

    if (!res.ok) {
      throw new Error(`ESPN returned HTTP ${res.status}`);
    }

    const data = await res.json();
    log(`Got response. Teams found: ${data.teams?.length ?? 0}`, 'ok');

    if (!data.teams?.length) {
      throw new Error('No teams in response — are you logged into ESPN?');
    }

    // Parse teams
    const teams = data.teams.map(team => {
      const name = team.name || team.nickname || team.abbrev || `Team ${team.id}`;
      const s    = team.valuesByStat || {};
      const fgm  = safeGet(s, STAT.fgm), fga = safeGet(s, STAT.fga);
      const ftm  = safeGet(s, STAT.ftm), fta = safeGet(s, STAT.fta);

      return {
        name,
        fgPct:   parseFloat((fga > 0 ? fgm/fga : 0).toFixed(8)),
        ftPct:   parseFloat((fta > 0 ? ftm/fta : 0).toFixed(8)),
        threePM: Math.round(safeGet(s, STAT.threePM)),
        reb:     Math.round(safeGet(s, STAT.reb)),
        ast:     Math.round(safeGet(s, STAT.ast)),
        stl:     Math.round(safeGet(s, STAT.stl)),
        blk:     Math.round(safeGet(s, STAT.blk)),
        pts:     Math.round(safeGet(s, STAT.pts)),
        gp:      Math.round(safeGet(s, STAT.gp)) || 550,
      };
    });

    const totalPts = teams.reduce((s,t) => s + t.pts, 0);
    if (totalPts === 0) {
      log('⚠ All PTS values are 0 — ESPN may have changed their stat IDs.', 'warn');
    }

    log(`Parsed ${teams.length} teams. Total PTS across league: ${totalPts}`, 'ok');
    teams.forEach(t => log(`  ${t.name} — PTS: ${t.pts}  GP: ${t.gp}`, 'info'));

    parsedTeams = teams;

    // Show preview with rankings
    const ranked = rankTeams(JSON.parse(JSON.stringify(teams)));
    const tbody = document.getElementById('previewBody');
    tbody.innerHTML = ranked.map((t, i) => `
      <tr>
        <td><span class="rank-badge rank-${i+1}">${i+1}</span></td>
        <td>${t.name}</td>
        <td class="score-val">${t.totalScore}</td>
        <td>${t.pts}</td>
        <td>${t.reb}</td>
        <td>${t.ast}</td>
        <td>${t.gp}</td>
      </tr>
    `).join('');
    document.getElementById('preview').style.display = 'block';

    setStatus('ok', 'Data fetched successfully');
    document.getElementById('pushBtn').disabled = false;
    log('✓ Ready to push to GitHub!', 'ok');

  } catch (err) {
    setStatus('err', 'Fetch failed');
    log(`Error: ${err.message}`, 'err');
    if (err.message.includes('NetworkError') || err.message.includes('Failed to fetch')) {
      log('→ Make sure you are logged into fantasy.espn.com in this browser', 'warn');
      log('→ If using a different browser profile, log in there first', 'warn');
    }
  }
}

async function pushToGitHub() {
  if (!parsedTeams) return;

  const token  = document.getElementById('ghToken').value.trim();
  const repo   = document.getElementById('ghRepo').value.trim();
  const branch = document.getElementById('ghBranch').value.trim() || 'main';

  if (!token) { log('⚠ Enter your GitHub token first', 'warn'); return; }
  if (!repo)  { log('⚠ Enter your GitHub repo (owner/repo)', 'warn'); return; }

  setStatus('working', 'Pushing to GitHub...');
  log(`Pushing to ${repo}/${FILE_PATH} on branch ${branch}...`, 'info');

  document.getElementById('pushBtn').disabled = true;

  const apiBase = `https://api.github.com/repos/${repo}/contents/${FILE_PATH}`;
  const headers = {
    'Authorization': `token ${token}`,
    'Accept': 'application/vnd.github.v3+json',
    'Content-Type': 'application/json',
  };

  try {
    // Get current file SHA (needed to update existing file)
    let sha = null;
    const existing = await fetch(`${apiBase}?ref=${branch}`, { headers });
    if (existing.ok) {
      const d = await existing.json();
      sha = d.sha;
      log(`Found existing file (sha: ${sha.slice(0,8)}...)`, 'info');
    } else if (existing.status === 404) {
      log('File does not exist yet — will create it.', 'info');
    } else {
      throw new Error(`GitHub API error: ${existing.status}`);
    }

    // Encode content as base64
    const content = JSON.stringify(parsedTeams, null, 2);
    const encoded = btoa(unescape(encodeURIComponent(content)));

    const now = new Date().toLocaleString();
    const body = {
      message: `chore: update standings data (${now})`,
      content: encoded,
      branch,
      ...(sha ? { sha } : {})
    };

    const res = await fetch(apiBase, {
      method: 'PUT',
      headers,
      body: JSON.stringify(body),
    });

    if (!res.ok) {
      const err = await res.json();
      throw new Error(err.message || `GitHub returned ${res.status}`);
    }

    const result = await res.json();
    log(`✓ Successfully pushed! Commit: ${result.commit.sha.slice(0,8)}`, 'ok');
    log('Netlify will redeploy automatically in ~30 seconds.', 'ok');
    setStatus('ok', 'Pushed to GitHub ✓');

  } catch (err) {
    setStatus('err', 'Push failed');
    log(`Error: ${err.message}`, 'err');
    if (err.message.includes('Bad credentials')) {
      log('→ Check your GitHub token — it may be expired or have wrong permissions', 'warn');
    }
    document.getElementById('pushBtn').disabled = false;
  }
}
</script>
</body>
</html>
